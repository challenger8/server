CREATE TABLE t1 (id INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;
CREATE TABLE t2 (
id INT NOT NULL PRIMARY KEY,
ref_id INT NOT NULL DEFAULT 0,
f INT NULL,
FOREIGN KEY (ref_id) REFERENCES t1 (id) ON DELETE CASCADE
) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1),(2);
INSERT INTO t2 VALUES (1,1,10),(2,2,20);
connect  con1,localhost,root,,;
BEGIN;
UPDATE t2 SET ref_id = 2 WHERE id = 1;
connection default;
SET innodb_lock_wait_timeout=1;
SET lock_wait_timeout=2;
RENAME TABLE t1 TO t3;
ERROR HY000: Error on rename of './test/t1' to './test/t3' (errno: 146 "Lock timed out; Retry transaction")
UPDATE t1 SET id = id + 2;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
ALTER TABLE t1 FORCE, ALGORITHM=COPY;
ERROR HY000: Error on rename of './test/t1' to './test/#sql2-temporary' (errno: 146 "Lock timed out; Retry transaction")
ALTER TABLE t1 FORCE, ALGORITHM=INPLACE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
ALTER TABLE t2 FORCE, ALGORITHM=COPY;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
ALTER TABLE t2 FORCE, ALGORITHM=INPLACE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
connection con1;
COMMIT;
disconnect con1;
connection default;
SELECT * FROM t1;
id
1
2
SELECT * FROM t2;
id	ref_id	f
1	2	10
2	2	20
DELETE FROM t1 WHERE id = 1;
SELECT * FROM t2;
id	ref_id	f
1	2	10
2	2	20
DROP TABLE t2, t1;
