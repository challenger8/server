--source include/have_innodb.inc

CREATE TABLE t1 (id INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;

CREATE TABLE t2 (
  id INT NOT NULL PRIMARY KEY,
  ref_id INT NOT NULL DEFAULT 0,
  f INT NULL,
  FOREIGN KEY (ref_id) REFERENCES t1 (id) ON DELETE CASCADE
) ENGINE=InnoDB;

INSERT INTO t1 VALUES (1),(2);
INSERT INTO t2 VALUES (1,1,10),(2,2,20);

--connect (con1,localhost,root,,)
BEGIN;
UPDATE t2 SET ref_id = 2 WHERE id = 1;

--connection default
SET innodb_lock_wait_timeout=1;
SET lock_wait_timeout=2;

--error ER_ERROR_ON_RENAME
RENAME TABLE t1 TO t3;
--error ER_LOCK_WAIT_TIMEOUT
UPDATE t1 SET id = id + 2;
--replace_regex /#sql2-.*'/#sql2-temporary'/
--error ER_ERROR_ON_RENAME
ALTER TABLE t1 FORCE, ALGORITHM=COPY;
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t1 FORCE, ALGORITHM=INPLACE;
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t2 FORCE, ALGORITHM=COPY;
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t2 FORCE, ALGORITHM=INPLACE;

--connection con1
COMMIT;
--disconnect con1

--connection default
SELECT * FROM t1;
SELECT * FROM t2;
DELETE FROM t1 WHERE id = 1;
SELECT * FROM t2;

DROP TABLE t2, t1;
